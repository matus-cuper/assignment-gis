<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>

    <link rel="stylesheet" type="text/css" href="index.css">

    <title>Projekt na PDT</title>
  </head>

  <body>

    <div id="mapid"></div>

    <form action="">
      <input type="radio" name="use-case" id="uc-points">Points</input>
      <input type="radio" name="use-case" id="uc-rectangles">Rectangles</input>
      <input type="radio" name="use-case" id="uc-paths">Paths</input>
    </form>

    <div class="checkbox-group required">
      <input type="checkbox" name="entity-type" id="et-bars">Bars</input>
      <input type="checkbox" name="entity-type" id="et-hotels">Hotels</input>
      <input type="checkbox" name="entity-type" id="et-restaurants">Restaurants</input>
    </div>

    <form>
      Distance (between 1 and 999 999):
      <input type="number" name="distance" id="param-distance" min="1" max="999999">
    </form>

    <form>
      Limit (between 1 and 9 999):
      <input type="number" name="limit" id="param-limit" min="1" max="9999">
    </form>

    <script>
      var getJSON = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
        xhr.responseType = 'json';
        xhr.onload = function() {
          var status = xhr.status;
          if (status === 200) {
            callback(null, xhr.response);
          } else {
            callback(status, xhr.response);
          }
        };
        xhr.send();
      };

      var getAmenities = function() {
        var tmp = '';
        if (document.getElementById('et-bars').checked) {
          tmp += '&amenity[]=bars';
        }
        if (document.getElementById('et-hotels').checked) {
          tmp += '&amenity[]=hotels';
        }
        if (document.getElementById('et-restaurants').checked) {
          tmp += '&amenity[]=restaurants';
        }

        return tmp;
      };

      var getParams = function() {
        var tmp = '';
        if (!isNaN(parseInt(document.getElementById('param-distance').value))) {
          tmp += ('&distance=' + parseInt(document.getElementById('param-distance').value));
        }
        if (!isNaN(parseInt(document.getElementById('param-limit').value))) {
          tmp += ('&limit=' + parseInt(document.getElementById('param-limit').value));
        }

        if (tmp == '')
          return '&limit=10';
        return tmp;
      };

      var setupMarker = function(data) {
        var marker = L.marker([data['lat'], data['lon']]);
        var t = '<dl><dt><b>Name:     </b> ' + data['name'] + '</dt>'
                  + '<dt><b>Category: </b> ' + data['category'] + '</dt>'
                  + '<dt><b>Amenity:  </b> ' + data['amenity'] + '</dt></dl>'

        marker.bindTooltip(t).openTooltip();
        return marker;
      };


      var mymap = L.map('mapid').setView([48.1472665, 17.1088840], 15);
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoiY3VwbyIsImEiOiJjajhibW9pczQwc3M0MnFwOGo3dDFncWwzIn0.VlG1EafnmV5KoZFf_1EUBQ'
      }).addTo(mymap);


      var popup = L.popup();
      var markers = L.layerGroup().addTo(mymap);

      function onMapClick(e) {

        if (document.getElementById('uc-points').checked) {
          var amenities = getAmenities();
          if (amenities != '') {
            var request = 'http://127.0.0.1:3000/api/points?' + amenities + '&lon=' + e.latlng['lng'] + '&lat=' + e.latlng['lat'] + getParams();
            getJSON(request,
            function(err, data) {
              if (err !== null) {
                console.log('Error occurred during getting response from nodejs: ' + err);
              } else {
                markers.clearLayers();

                if (parseInt(document.getElementById('param-distance').value)) {
                  L.circle([e.latlng['lat'], e.latlng['lng']], {
                    color: 'yellow',
                    fillColor: '#ff0',
                    fillOpacity: 0.2,
                    radius: parseInt(document.getElementById('param-distance').value)
                  }).addTo(markers);
                }

                console.log('Request sent to backend ' + request);
                console.log('Fetched ' + data.length + ' objects');
                for (d in data) {
                  setupMarker(data[d]).addTo(markers);
                  console.log(data[d]);
                }
              }
            });
          }
        }
        else if (document.getElementById('uc-rectangles').checked) {
          console.log('uc-rectangles');
        }
        else if (document.getElementById('uc-paths').checked) {
          console.log('uc-paths');
        }
      };

      mymap.on('click', onMapClick);

    </script>

    <h1>Ahoj</h1>
  </body>
</html>
